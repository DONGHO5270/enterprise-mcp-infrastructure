version: '3.8'

# Claude Desktop ì „ìš© ì•ˆì „í•œ MCP ë¸Œë¦¬ì§€ ì„œë¹„ìŠ¤
# í¬íŠ¸ 3200ìœ¼ë¡œ Claude Code CLIì™€ ì™„ì „ ë¶„ë¦¬

x-encoding-env: &encoding-env
  LANG: C.UTF-8
  LC_ALL: C.UTF-8
  PYTHONIOENCODING: utf-8
  TZ: Asia/Seoul

networks:
  mcp-network:
    external: true

volumes:
  desktop-bridge-logs:

services:
  # Claude Desktop ì „ìš© MCP Router (í¬íŠ¸ 3200)
  mcp-desktop-router:
    build:
      context: ../../services/mcp-router
      dockerfile: Dockerfile
    container_name: mcp-desktop-router
    restart: unless-stopped
    networks:
      - mcp-network
    ports:
      - "3200:3000"  # Claude Desktop ì „ìš© í¬íŠ¸
    environment:
      <<: *encoding-env
      NODE_ENV: production
      LOG_LEVEL: info
      MAX_CONCURRENT_PROCESSES: 5  # Desktopìš© ì œí•œ
      REQUEST_TIMEOUT: 45000
      PROCESS_IDLE_TIMEOUT: 30000
      SERVICE_NAME: "desktop-router"
    volumes:
      # ê¸°ì¡´ MCP ì„œë¹„ìŠ¤ë“¤ ì¬ì‚¬ìš© (ì½ê¸°/ì“°ê¸° ê°€ëŠ¥)
      - ../../services/mcp:/app/services/mcp
      # ë…ë¦½ì ì¸ ë¡œê·¸ ë³¼ë¥¨
      - desktop-bridge-logs:/logs
      # ì„¤ì • íŒŒì¼ë“¤
      - ../../configs/api-keys.env:/app/configs/api-keys.env:ro
      - ../../configs/environment.env:/app/configs/environment.env:ro
      # í•„ìš”í•œ ê²½ìš° WSL ì ‘ê·¼
      - /mnt/c:/workspace
    env_file:
      - ../../configs/api-keys.env
      - ../../configs/environment.env
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => { process.exit(1); })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    # ê¸°ì¡´ ë¼ìš°í„°ì™€ ë…ë¦½ ì‹¤í–‰
    depends_on: []
    
  # Claude Desktop ë¸Œë¦¬ì§€ í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤ (ì„ íƒì )
  desktop-bridge-test:
    image: node:20-alpine
    container_name: desktop-bridge-test
    networks:
      - mcp-network
    working_dir: /app
    volumes:
      - ../../services:/app/services:ro
    environment:
      <<: *encoding-env
      MCP_DESKTOP_ROUTER_URL: "http://mcp-desktop-router:3000"
      DEBUG: "true"
    command: |
      sh -c "
        echo 'ğŸ§ª Claude Desktop ë¸Œë¦¬ì§€ í…ŒìŠ¤íŠ¸ ì¤€ë¹„ ì™„ë£Œ'
        echo 'ğŸ“¡ ë¼ìš°í„° URL: http://mcp-desktop-router:3000'
        echo 'ğŸ”— ì™¸ë¶€ ì ‘ê·¼: http://localhost:3200'
        sleep infinity
      "
    profiles:
      - test  # í…ŒìŠ¤íŠ¸ ì‹œì—ë§Œ ì‹¤í–‰ (docker-compose --profile test up)